---
import { seoManager, type SEOConfig } from '../utils/seoManager';
import PerformanceMonitor from '../components/PerformanceMonitor.astro';

export interface Props {
  title: string;
  description?: string;
  lang?: 'en' | 'es' | 'ca';
  type?: 'website' | 'article' | 'profile';
  image?: string;
  imageAlt?: string;
  keywords?: string[];
  author?: string;
  publishedTime?: string;
  modifiedTime?: string;
  section?: string;
  tags?: string[];
  noindex?: boolean;
  nofollow?: boolean;
  priority?: number;
  changefreq?: 'always' | 'hourly' | 'daily' | 'weekly' | 'monthly' | 'yearly' | 'never';
  breadcrumbs?: Array<{ name: string; url: string }>;
  customSchema?: Record<string, any>;
  pathname?: string;
}

const { 
  title, 
  description = 'Biomedical engineer and molecular biologist developing next-generation antimicrobial therapies through AI-driven protein engineering', 
  lang = 'en',
  type = 'website',
  image,
  imageAlt,
  keywords,
  author,
  publishedTime,
  modifiedTime,
  section,
  tags,
  noindex = false,
  nofollow = false,
  priority,
  changefreq,
  breadcrumbs,
  customSchema,
  pathname
} = Astro.props;

// Use provided pathname or fall back to Astro.url.pathname for backwards compatibility
const currentPathname = pathname || (typeof Astro !== 'undefined' && Astro.url ? Astro.url.pathname : '/');

const seoConfig: SEOConfig = {
  title,
  description,
  lang,
  canonical: seoManager.generateCanonicalUrl(currentPathname, lang),
  type,
  image,
  imageAlt,
  keywords,
  author,
  publishedTime,
  modifiedTime,
  section,
  tags,
  noindex,
  nofollow,
  priority,
  changefreq,
  breadcrumbs,
  schema: customSchema
};

const hreflangLinks = seoManager.generateHreflangLinks(currentPathname);
const seoHeadContent = seoManager.generateSEOHead(seoConfig);
---

<!DOCTYPE html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    
    <!-- SEO Meta Tags -->
    <Fragment set:html={seoManager.generateMetaTags(seoConfig)} />
    
    <!-- Hreflang Links -->
    {hreflangLinks.map(link => (
      <link rel="alternate" href={link.href} hreflang={link.hreflang} />
    ))}
    
    <!-- Structured Data -->
    <Fragment set:html={seoManager.generatePersonSchema()} />
    <Fragment set:html={seoManager.generateWebsiteSchema(seoConfig)} />
    
    {breadcrumbs && (
      <Fragment set:html={seoManager.generateBreadcrumbSchema(breadcrumbs)} />
    )}
    
    {customSchema && (
      <script type="application/ld+json" set:html={JSON.stringify(customSchema, null, 2)}></script>
    )}
    
    <!-- Open Graph Tags -->
    <Fragment set:html={seoManager.generateOpenGraphTags(seoConfig)} />
    
    <!-- Twitter Card Tags -->
    <Fragment set:html={seoManager.generateTwitterTags(seoConfig)} />
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    
    <!-- Inline Critical CSS - Above-the-fold performance -->
    <style>
      /* Design System Core - Essential tokens only */
      :root{--catalan-red:#DA291C;--catalan-yellow:#FFD93D;--primary:#F5F5F5;--secondary:#D4D4D4;--tertiary:#B8B8B8;--accent-red:#EF4444;--accent-red-hover:#FF5555;--accent-red-bg:rgba(220,38,38,0.10);--accent-yellow:#FFD93D;--background:#0A0A0A;--background-alt:#171717;--background-card:#1E1E1E;--background-elevated:#252525;--background-rgb:10,10,10;--accent-red-rgb:220,38,38;--border:#333333;--border-light:#404040;--border-red:rgba(218,41,28,0.3);--font-primary:'Inter',-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;--font-display:'Outfit',-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;--font-mono:'SF Mono',Monaco,'Cascadia Code',monospace;--space-xs:0.5rem;--space-sm:1rem;--space-md:2rem;--space-lg:4rem;--space-xl:8rem;--anim-duration-fast:200ms;--anim-duration-base:300ms;--anim-duration-slow:500ms;--anim-easing-default:cubic-bezier(0.4,0,0.2,1);--glass-bg:rgba(255,255,255,0.05);--glass-border:rgba(255,255,255,0.1);--glass-blur:16px;--z-base:0;--z-dropdown:100;--z-sticky:200;--z-modal:300;--z-toast:400}*{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}body{font-family:var(--font-primary);font-weight:400;line-height:1.75;color:var(--primary);background-color:var(--background);font-size:clamp(16px,2vw,18px);letter-spacing:0.01em;word-spacing:0.05em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility}.glass{background:var(--glass-bg);backdrop-filter:blur(var(--glass-blur));border:1px solid var(--glass-border)}.gpu-accelerated{transform:translateZ(0);backface-visibility:hidden;perspective:1000px}.will-change-transform{will-change:transform}.will-change-opacity{will-change:opacity}.will-change-auto{will-change:auto}.container{max-width:1280px;margin:0 auto;padding:0 25px}.section{padding:var(--space-xl) 0;position:relative}.nav-premium{position:fixed;top:0;left:0;right:0;z-index:var(--z-sticky);background:radial-gradient(120% 100% at 50% -20%,rgba(15,15,15,0.75) 0%,rgba(10,10,10,0.7) 100%);backdrop-filter:blur(16px);border-bottom:1px solid rgba(255,255,255,0.05);transition:transform var(--anim-duration-base) var(--anim-easing-default);will-change:transform}.hero-final{position:relative;min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--background);overflow:hidden}h1,h2,h3,h4,h5,h6{font-family:var(--font-display);font-weight:700;line-height:1.15;margin-bottom:1rem;letter-spacing:-0.01em;color:var(--primary)}h1{font-size:clamp(2.5rem,5vw,4rem)}h2{font-size:clamp(2rem,4vw,3rem)}h3{font-size:clamp(1.5rem,3vw,2rem)}.btn{padding:0.875rem 2rem;min-height:44px;font-size:1rem;font-weight:600;text-decoration:none;border-radius:8px;transition:all var(--anim-duration-base) var(--anim-easing-default);display:inline-flex;align-items:center;gap:0.75rem;position:relative;overflow:hidden;outline:none;cursor:pointer;border:none}.btn:focus-visible{box-shadow:0 0 0 3px rgba(239,68,68,.45),0 0 0 5px rgba(255,255,255,.15)}.btn-primary{background:var(--accent-red);color:#FFFFFF;border:1px solid var(--accent-red);box-shadow:0 8px 30px rgba(220,38,38,0.25)}.btn-primary:hover{background:var(--accent-red-hover);box-shadow:0 10px 40px rgba(220,38,38,0.3);transform:translateY(-2px)}@media(max-width:768px){.section{padding:var(--space-lg) 0}.container{padding:0 1rem}.btn{min-height:48px;min-width:48px}}@media(prefers-reduced-motion:reduce){*{animation-duration:0.01ms!important;animation-iteration-count:1!important;transition-duration:0.01ms!important}html{scroll-behavior:auto}}
    </style>
    
    <!-- Optimized CSS Loading Strategy -->
    <!-- Core styles (essential) -->
    <link rel="preload" as="style" href="/Portfolio/styles/optimized-core.css" onload="this.onload=null;this.rel='stylesheet'">

    <!-- Enhanced styles (progressive enhancement) -->
    <link rel="preload" as="style" href="/Portfolio/styles/optimized-enhanced.css" onload="this.onload=null;this.rel='stylesheet'" media="screen">

    <!-- Accessibility styles -->
    <link rel="preload" as="style" href="/Portfolio/styles/optimized-accessibility.css" onload="this.onload=null;this.rel='stylesheet'">

    <noscript>
      <link rel="stylesheet" href="/Portfolio/styles/optimized-core.css">
      <link rel="stylesheet" href="/Portfolio/styles/optimized-enhanced.css">
      <link rel="stylesheet" href="/Portfolio/styles/optimized-accessibility.css">
    </noscript>
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    </noscript>
  </head>
  <body>
    <a class="skip-link" href="#main" tabindex="0">Skip to main content</a>
    <main id="main" role="main" aria-label="Main content">
      <slot />
    </main>
    
    <!-- Performance Monitor - Development Only -->
    <script>
      if (import.meta.env.DEV) {
        // Dynamically import the performance dashboard in development
        import('/src/components/PerformanceDashboard.tsx')
          .then(({ PerformanceDashboard }) => {
            import('react').then((React) => {
              import('react-dom/client').then((ReactDOM) => {
                const container = document.createElement('div');
                container.id = 'performance-dashboard-root';
                document.body.appendChild(container);
                
                const root = ReactDOM.createRoot(container);
                root.render(React.createElement(PerformanceDashboard));
              });
            });
          })
          .catch(console.warn);
      }
    </script>

    <!-- Performance Monitor Component -->
    <PerformanceMonitor />
  </body>
</html>

