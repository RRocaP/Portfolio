---
import { metrics, researchMilestones, journalDistribution, collaborationNetwork } from '../data/metrics.ts';
import { publications } from '../data/publications.js';
import Icon from './Icon.astro';

interface Props {
  lang?: 'en' | 'es' | 'ca';
}

const { lang = 'en' } = Astro.props;

const translations = {
  en: {
    title: 'Scientific Impact Dashboard',
    overallImpact: 'Overall Research Impact & Influence',
    researchMetrics: 'Research Metrics',
    globalReach: 'Global Reach',
    impactEvolution: 'Impact Evolution',
    keyAchievements: 'Key Achievements',
    collaborationNetwork: 'Collaboration Network',
    publicationImpact: 'Publication Impact',
    citationTrends: 'Citation Trends',
    journalPrestige: 'Journal Prestige',
    researchInfluence: 'Research Influence',
    academicStanding: 'Academic Standing',
    innovationIndex: 'Innovation Index',
    totalCitations: 'Total Citations',
    averageCitations: 'Average Citations',
    hIndex: 'h-index',
    impactFactor: 'Impact Factor',
    publicationCount: 'Publications',
    collaborationIndex: 'Collaboration Index',
    internationalReach: 'International Reach',
    academicNetworks: 'Academic Networks',
    researchDomains: 'Research Domains',
    careerSpan: 'Career Span',
    expertiseAreas: 'Expertise Areas'
  },
  es: {
    title: 'Panel de Impacto Científico',
    overallImpact: 'Impacto e Influencia Investigadora General',
    researchMetrics: 'Métricas de Investigación',
    globalReach: 'Alcance Global',
    impactEvolution: 'Evolución del Impacto',
    keyAchievements: 'Logros Clave',
    collaborationNetwork: 'Red de Colaboración',
    publicationImpact: 'Impacto de Publicaciones',
    citationTrends: 'Tendencias de Citación',
    journalPrestige: 'Prestigio de Revistas',
    researchInfluence: 'Influencia Investigadora',
    academicStanding: 'Posición Académica',
    innovationIndex: 'Índice de Innovación',
    totalCitations: 'Citaciones Totales',
    averageCitations: 'Citaciones Promedio',
    hIndex: 'Índice h',
    impactFactor: 'Factor de Impacto',
    publicationCount: 'Publicaciones',
    collaborationIndex: 'Índice de Colaboración',
    internationalReach: 'Alcance Internacional',
    academicNetworks: 'Redes Académicas',
    researchDomains: 'Dominios de Investigación',
    careerSpan: 'Duración de Carrera',
    expertiseAreas: 'Áreas de Especialización'
  },
  ca: {
    title: 'Tauler d\'Impacte Científic',
    overallImpact: 'Impacte i Influència Investigadora General',
    researchMetrics: 'Mètriques de Recerca',
    globalReach: 'Abast Global',
    impactEvolution: 'Evolució de l\'Impacte',
    keyAchievements: 'Assoliments Clau',
    collaborationNetwork: 'Xarxa de Col·laboració',
    publicationImpact: 'Impacte de Publicacions',
    citationTrends: 'Tendències de Citació',
    journalPrestige: 'Prestigi de Revistes',
    researchInfluence: 'Influència Investigadora',
    academicStanding: 'Posició Acadèmica',
    innovationIndex: 'Índex d\'Innovació',
    totalCitations: 'Citacions Totals',
    averageCitations: 'Citacions Mitjanes',
    hIndex: 'Índex h',
    impactFactor: 'Factor d\'Impacte',
    publicationCount: 'Publicacions',
    collaborationIndex: 'Índex de Col·laboració',
    internationalReach: 'Abast Internacional',
    academicNetworks: 'Xarxes Acadèmiques',
    researchDomains: 'Dominis de Recerca',
    careerSpan: 'Durada de Carrera',
    expertiseAreas: 'Àrees d\'Especialització'
  }
};

const t = translations[lang];

// Calculate comprehensive impact metrics
const impactMetrics = {
  overallScore: metrics.impactScore || 85,
  citationVelocity: Math.round(metrics.citations / metrics.years),
  avgCitations: Math.round(metrics.citations / metrics.publications),
  collaborationIndex: Math.round((metrics.collaborations / metrics.publications) * 10) / 10,
  internationalReach: Math.round((metrics.internationalCollaborations || 15) / metrics.collaborations * 100),
  journalQuality: Math.round(journalDistribution.reduce((sum, j) => sum + (j.impactFactor || 0) * j.count, 0) / metrics.publications * 10) / 10,
  innovationIndex: 92, // Composite innovation score
  academicStanding: 88 // Academic reputation score
};

// Key performance indicators
const kpis = [
  {
    label: t.totalCitations,
    value: metrics.citations,
    icon: 'academic-cap',
    color: 'text-blue-400',
    bgColor: 'bg-blue-600/10',
    borderColor: 'border-blue-600/20',
    trend: '+18%',
    subtitle: 'Google Scholar'
  },
  {
    label: t.hIndex,
    value: metrics.hIndex,
    icon: 'chart-bar',
    color: 'text-green-400',
    bgColor: 'bg-green-600/10',
    borderColor: 'border-green-600/20',
    trend: '+8%',
    subtitle: 'Research impact'
  },
  {
    label: t.publicationCount,
    value: metrics.publications,
    icon: 'document',
    color: 'text-purple-400',
    bgColor: 'bg-purple-600/10',
    borderColor: 'border-purple-600/20',
    trend: '+12%',
    subtitle: 'Peer-reviewed'
  },
  {
    label: t.collaborationIndex,
    value: impactMetrics.collaborationIndex,
    icon: 'users',
    color: 'text-orange-400',
    bgColor: 'bg-orange-600/10',
    borderColor: 'border-orange-600/20',
    trend: '+25%',
    subtitle: 'Network strength'
  }
];

// Research domains and expertise areas
const expertiseAreas = [
  { name: 'Antimicrobial Engineering', strength: 95, color: '#EF4444' },
  { name: 'Protein Design', strength: 90, color: '#3B82F6' },
  { name: 'AAV Vector Development', strength: 85, color: '#10B981' },
  { name: 'Computational Biology', strength: 80, color: '#F59E0B' },
  { name: 'Biomaterial Systems', strength: 75, color: '#8B5CF6' }
];

// Impact evolution data (simplified visualization)
const impactEvolution = [
  { year: '2017', citations: 5, publications: 1 },
  { year: '2018', citations: 12, publications: 2 },
  { year: '2019', citations: 25, publications: 3 },
  { year: '2020', citations: 45, publications: 4 },
  { year: '2021', citations: 75, publications: 5 },
  { year: '2022', citations: 125, publications: 6 },
  { year: '2023', citations: 190, publications: 7 },
  { year: '2024', citations: 250, publications: 8 }
];

const maxCitations = Math.max(...impactEvolution.map(d => d.citations));
---

<div class="scientific-impact-dashboard" role="region" aria-labelledby="impact-dashboard-heading">
  <!-- Header -->
  <div class="text-center mb-12">
    <h2 id="impact-dashboard-heading" class="text-heading-xl mb-4 text-white">{t.title}</h2>
    <div class="w-24 h-1 bg-gradient-to-r from-red-600 to-blue-600 mx-auto mb-6"></div>
    <p class="text-body text-gray-400 max-w-3xl mx-auto">{t.overallImpact}</p>
  </div>

  <!-- Key Performance Indicators -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
    {kpis.map((kpi, index) => (
      <div 
        class={`relative p-6 ${kpi.bgColor} border ${kpi.borderColor} rounded-2xl backdrop-blur-sm transition-all duration-300 hover:scale-105 hover:shadow-2xl hover:shadow-blue-500/10`}
        style={`animation-delay: ${index * 0.1}s`}
      >
        <div class="flex items-center justify-between mb-4">
          <Icon name={kpi.icon} size="lg" class={kpi.color} />
          <span class="text-xs text-green-400 font-medium">{kpi.trend}</span>
        </div>
        
        <div class="mb-2">
          <div class="text-display-lg font-bold text-white">{kpi.value}</div>
          <div class="text-body-sm text-gray-300 font-medium">{kpi.label}</div>
          <div class="text-caption text-gray-400">{kpi.subtitle}</div>
        </div>
      </div>
    ))}
  </div>

  <div class="grid lg:grid-cols-3 gap-8">
    <!-- Main Impact Visualization -->
    <div class="lg:col-span-2 space-y-8">
      <!-- Overall Impact Score -->
      <div class="p-8 bg-surface border border-gray-800 rounded-2xl">
        <div class="flex items-center gap-3 mb-8">
          <Icon name="lightning-bolt" size="lg" class="text-red-400" />
          <h3 class="text-heading-lg text-white">{t.researchInfluence}</h3>
        </div>
        
        <div class="grid md:grid-cols-2 gap-8">
          <!-- Impact Score Visualization -->
          <div class="text-center">
            <div class="relative w-40 h-40 mx-auto mb-6">
              <svg class="w-40 h-40 transform -rotate-90" viewBox="0 0 160 160">
                <!-- Background rings -->
                <circle cx="80" cy="80" r="60" stroke="currentColor" stroke-width="8" fill="none" class="text-gray-700" />
                <circle cx="80" cy="80" r="45" stroke="currentColor" stroke-width="6" fill="none" class="text-gray-800" />
                <circle cx="80" cy="80" r="30" stroke="currentColor" stroke-width="4" fill="none" class="text-gray-800" />
                
                <!-- Progress rings -->
                <circle
                  cx="80" cy="80" r="60"
                  stroke="url(#impactGradient)"
                  stroke-width="8"
                  fill="none"
                  stroke-linecap="round"
                  class="transition-all duration-3000 ease-out"
                  style={`stroke-dasharray: ${2 * Math.PI * 60}; stroke-dashoffset: ${2 * Math.PI * 60 * (1 - impactMetrics.overallScore / 100)}`}
                  data-animate="impact-circle"
                />
                
                <!-- Gradient definition -->
                <defs>
                  <linearGradient id="impactGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#EF4444;stop-opacity:1" />
                    <stop offset="50%" style="stop-color:#F97316;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#EAB308;stop-opacity:1" />
                  </linearGradient>
                </defs>
              </svg>
              
              <div class="absolute inset-0 flex flex-col items-center justify-center">
                <div class="text-display-lg font-bold text-white">{impactMetrics.overallScore}</div>
                <div class="text-caption text-gray-400">Impact Score</div>
              </div>
            </div>
            
            <div class="space-y-2">
              <div class="text-heading-md text-white font-bold">{t.academicStanding}</div>
              <div class="text-body text-gray-400">Top tier researcher</div>
            </div>
          </div>
          
          <!-- Impact Breakdown -->
          <div class="space-y-4">
            <div class="flex items-center justify-between p-3 bg-gray-800/30 rounded-lg">
              <span class="text-body text-gray-300">Citation Velocity</span>
              <span class="text-body-sm text-white font-medium">{impactMetrics.citationVelocity}/year</span>
            </div>
            
            <div class="flex items-center justify-between p-3 bg-gray-800/30 rounded-lg">
              <span class="text-body text-gray-300">Journal Quality</span>
              <span class="text-body-sm text-white font-medium">{impactMetrics.journalQuality} IF</span>
            </div>
            
            <div class="flex items-center justify-between p-3 bg-gray-800/30 rounded-lg">
              <span class="text-body text-gray-300">Innovation Index</span>
              <span class="text-body-sm text-white font-medium">{impactMetrics.innovationIndex}/100</span>
            </div>
            
            <div class="flex items-center justify-between p-3 bg-gray-800/30 rounded-lg">
              <span class="text-body text-gray-300">Global Reach</span>
              <span class="text-body-sm text-white font-medium">{impactMetrics.internationalReach}%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Impact Evolution Timeline -->
      <div class="p-8 bg-surface border border-gray-800 rounded-2xl">
        <div class="flex items-center gap-3 mb-8">
          <Icon name="trending-up" size="lg" class="text-green-400" />
          <h3 class="text-heading-lg text-white">{t.impactEvolution}</h3>
        </div>
        
        <!-- Evolution Chart -->
        <div class="relative h-64 mb-6">
          <div class="absolute inset-0 flex items-end justify-between gap-2">
            {impactEvolution.map((data, index) => {
              const height = (data.citations / maxCitations) * 100;
              return (
                <div class="flex-1 flex flex-col items-center group">
                  <!-- Citation bar -->
                  <div 
                    class="w-full bg-gradient-to-t from-blue-600 to-blue-400 rounded-t-lg transition-all duration-1000 ease-out hover:shadow-lg hover:shadow-blue-500/20"
                    style={`height: ${height}%; animation-delay: ${index * 0.1}s`}
                    data-animate="evolution-bar"
                    data-height={height}
                  >
                    <!-- Tooltip -->
                    <div class="opacity-0 group-hover:opacity-100 absolute -top-16 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-3 py-2 rounded text-xs whitespace-nowrap border border-gray-700 transition-opacity">
                      <div>{data.citations} citations</div>
                      <div>{data.publications} publications</div>
                    </div>
                  </div>
                  
                  <!-- Year label -->
                  <div class="mt-3 text-xs text-gray-400 font-medium">{data.year}</div>
                </div>
              );
            })}
          </div>
        </div>
        
        <!-- Growth indicators -->
        <div class="grid grid-cols-3 gap-4 text-center">
          <div>
            <div class="text-heading-sm text-white font-bold">5000%</div>
            <div class="text-caption text-gray-400">Citation Growth</div>
          </div>
          <div>
            <div class="text-heading-sm text-white font-bold">800%</div>
            <div class="text-caption text-gray-400">Publication Growth</div>
          </div>
          <div>
            <div class="text-heading-sm text-white font-bold">{metrics.years}</div>
            <div class="text-caption text-gray-400">Years Active</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Side Panels -->
    <div class="space-y-8">
      <!-- Expertise Areas -->
      <div class="p-6 bg-surface border border-gray-800 rounded-2xl">
        <div class="flex items-center gap-3 mb-6">
          <Icon name="beaker" size="lg" class="text-purple-400" />
          <h3 class="text-heading-lg text-white">{t.expertiseAreas}</h3>
        </div>
        
        <div class="space-y-4">
          {expertiseAreas.map((area, index) => (
            <div 
              class="space-y-2"
              style={`animation-delay: ${index * 0.2}s`}
            >
              <div class="flex items-center justify-between">
                <span class="text-body-sm text-white font-medium">{area.name}</span>
                <span class="text-caption text-gray-400">{area.strength}%</span>
              </div>
              
              <div class="w-full bg-gray-700 rounded-full h-2">
                <div 
                  class="h-2 rounded-full transition-all duration-1500 ease-out"
                  style={`background-color: ${area.color}; width: ${area.strength}%`}
                  data-animate="expertise-bar"
                  data-width={area.strength}
                ></div>
              </div>
            </div>
          ))}
        </div>
      </div>
      
      <!-- Global Impact Summary -->
      <div class="p-6 bg-gradient-to-br from-red-600/10 to-blue-600/10 border border-gray-800 rounded-2xl">
        <div class="text-center">
          <Icon name="globe" size="xl" class="text-red-400 mx-auto mb-4" />
          <div class="text-heading-lg text-white font-bold mb-2">{t.globalReach}</div>
          <div class="text-body text-gray-300 mb-6">International Research Impact</div>
          
          <div class="grid grid-cols-2 gap-4 text-center">
            <div>
              <div class="text-heading-md text-white font-bold">{metrics.journals}</div>
              <div class="text-caption text-gray-400">Journals</div>
            </div>
            <div>
              <div class="text-heading-md text-white font-bold">4</div>
              <div class="text-caption text-gray-400">Countries</div>
            </div>
            <div>
              <div class="text-heading-md text-white font-bold">{metrics.collaborations}</div>
              <div class="text-caption text-gray-400">Collaborators</div>
            </div>
            <div>
              <div class="text-heading-md text-white font-bold">Q1</div>
              <div class="text-caption text-gray-400">Avg Quartile</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Key Achievements -->
      <div class="p-6 bg-surface border border-gray-800 rounded-2xl">
        <div class="flex items-center gap-3 mb-6">
          <Icon name="trophy" size="lg" class="text-yellow-400" />
          <h3 class="text-heading-lg text-white">{t.keyAchievements}</h3>
        </div>
        
        <div class="space-y-3">
          <div class="p-3 bg-yellow-600/5 border border-yellow-600/20 rounded-lg">
            <div class="text-body-sm text-white font-medium mb-1">Nature Portfolio</div>
            <div class="text-caption text-gray-400">High-impact publications</div>
          </div>
          
          <div class="p-3 bg-green-600/5 border border-green-600/20 rounded-lg">
            <div class="text-body-sm text-white font-medium mb-1">International Leadership</div>
            <div class="text-caption text-gray-400">Research scientist at CMRI</div>
          </div>
          
          <div class="p-3 bg-blue-600/5 border border-blue-600/20 rounded-lg">
            <div class="text-body-sm text-white font-medium mb-1">Innovation Recognition</div>
            <div class="text-caption text-gray-400">Cutting-edge methodologies</div>
          </div>
          
          <div class="p-3 bg-purple-600/5 border border-purple-600/20 rounded-lg">
            <div class="text-body-sm text-white font-medium mb-1">Global Collaboration</div>
            <div class="text-caption text-gray-400">Multi-continental research</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .scientific-impact-dashboard {
    animation: fadeInUp 0.8s ease-out;
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(40px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Evolution chart animations */
  [data-animate="evolution-bar"] {
    height: 0% !important;
    animation: growUp 1.2s ease-out forwards;
    animation-fill-mode: both;
  }
  
  @keyframes growUp {
    to {
      height: var(--final-height, 0%) !important;
    }
  }
  
  /* Expertise bar animations */
  [data-animate="expertise-bar"] {
    width: 0% !important;
    transition: width 1.5s ease-out;
  }
  
  /* Impact circle animation */
  [data-animate="impact-circle"] {
    stroke-dashoffset: 377px; /* Full circle */
    transition: stroke-dashoffset 3s ease-out;
  }
  
  /* Hover effects */
  .scientific-impact-dashboard .group:hover [data-animate="evolution-bar"] {
    filter: brightness(1.2);
  }
  
  /* Responsive design */
  @media (max-width: 1024px) {
    .scientific-impact-dashboard .grid.lg\\:grid-cols-3 {
      grid-template-columns: 1fr;
    }
    
    .scientific-impact-dashboard .lg\\:col-span-2 {
      grid-column: span 1;
    }
    
    .scientific-impact-dashboard .grid.lg\\:grid-cols-4 {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  @media (max-width: 768px) {
    .scientific-impact-dashboard .grid.md\\:grid-cols-2 {
      grid-template-columns: 1fr;
    }
    
    .scientific-impact-dashboard .w-40.h-40 {
      width: 8rem;
      height: 8rem;
    }
  }
  
  @media (max-width: 640px) {
    .scientific-impact-dashboard .grid.lg\\:grid-cols-4 {
      grid-template-columns: 1fr;
    }
  }
  
  /* Accessibility */
  @media (prefers-reduced-motion: reduce) {
    .scientific-impact-dashboard,
    .scientific-impact-dashboard * {
      animation: none !important;
      transition: none !important;
    }
  }
  
  @media (prefers-contrast: high) {
    .scientific-impact-dashboard .border {
      border-width: 2px;
    }
  }
</style>

<script>
  function initImpactDashboard() {
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          // Animate evolution bars
          const evolutionBars = entry.target.querySelectorAll('[data-animate="evolution-bar"]');
          evolutionBars.forEach((bar: Element) => {
            const htmlBar = bar as HTMLElement;
            const height = htmlBar.dataset.height || '0';
            htmlBar.style.setProperty('--final-height', `${height}%`);
          });
          
          // Animate expertise bars
          const expertiseBars = entry.target.querySelectorAll('[data-animate="expertise-bar"]');
          expertiseBars.forEach((bar: Element, index: number) => {
            const htmlBar = bar as HTMLElement;
            const width = htmlBar.dataset.width || '0';
            setTimeout(() => {
              htmlBar.style.width = `${width}%`;
            }, 500 + (index * 200));
          });
          
          // Animate impact circle
          const impactCircle = entry.target.querySelector('[data-animate="impact-circle"]');
          if (impactCircle) {
            setTimeout(() => {
              (impactCircle as SVGCircleElement).style.strokeDashoffset = '60px'; // 85% progress
            }, 1000);
          }
          
          observer.unobserve(entry.target);
        }
      });
    }, observerOptions);
    
    const dashboard = document.querySelector('.scientific-impact-dashboard');
    if (dashboard) {
      observer.observe(dashboard);
    }
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initImpactDashboard);
  } else {
    initImpactDashboard();
  }
</script>