---
import type { Lang } from '../../data/i18n';
import { translations } from '../../data/i18n';
import { publications } from '../../data/publications.js';

export interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
const t = translations[lang] || translations.en;

const sectionHeading: Record<Lang, string> = {
  en: 'Publications',
  es: 'Publicaciones',
  ca: 'Publicacions',
};

const viewAllLabel: Record<Lang, string> = {
  en: 'View all on Google Scholar',
  es: 'Ver todo en Google Scholar',
  ca: 'Veure tot a Google Scholar',
};

function isFirstAuthor(pub: any): boolean {
  if (!pub.authors) return false;
  const authors = pub.authors.trim();
  return authors.startsWith('Roca-Pinilla R') || authors.startsWith('Roca-Pinilla,');
}

const sortedPubs = [...publications]
  .filter((p: any) => p.type !== 'thesis')
  .sort((a: any, b: any) => {
    const yearA = parseInt(a.year) || 0;
    const yearB = parseInt(b.year) || 0;
    return yearB - yearA;
  });

// Group publications by year for ledger layout
const pubsByYear = sortedPubs.reduce((acc: Record<string, any[]>, pub: any) => {
  const year = String(pub.year);
  if (!acc[year]) acc[year] = [];
  acc[year].push(pub);
  return acc;
}, {} as Record<string, any[]>);

const years = Object.keys(pubsByYear).sort((a, b) => parseInt(b) - parseInt(a));
---

<section id="publications" class="ml-pubs section" aria-labelledby="pubs-heading">
  <div class="container">
    <h2 id="pubs-heading" class="ml-pubs__heading">{sectionHeading[lang]}</h2>

    <div class="ml-pubs__ledger">
      {years.map((year) => (
        <div class="ml-pubs__year-group">
          <div class="ml-pubs__year-header">
            <span class="ml-pubs__year">{year}</span>
          </div>
          <div class="ml-pubs__year-entries">
            {pubsByYear[year].map((pub: any) => {
              const first = isFirstAuthor(pub);
              return (
                <article class:list={['ml-pubs__row', { 'ml-pubs__row--first': first }]}>
                  <div class="ml-pubs__row-content">
                    <h3 class="ml-pubs__title">
                      {pub.url && pub.url !== '#' ? (
                        <a href={pub.url} target="_blank" rel="noopener noreferrer" class="ml-pubs__title-link">
                          {pub.title}
                        </a>
                      ) : (
                        pub.title
                      )}
                    </h3>
                    <div class="ml-pubs__meta">
                      <span class="ml-pubs__journal">{pub.journal}</span>
                      <div class="ml-pubs__badges">
                        {first && <span class="ml-pubs__first-badge">1st Author</span>}
                        {pub.quartile && (
                          <span class:list={['ml-pubs__quartile-badge', `ml-pubs__quartile-badge--${pub.quartile.toLowerCase()}`]}>
                            {pub.quartile}
                          </span>
                        )}
                        {pub.impactFactor && (
                          <span class="ml-pubs__if-badge">IF {pub.impactFactor}</span>
                        )}
                      </div>
                    </div>
                  </div>
                </article>
              );
            })}
          </div>
        </div>
      ))}
    </div>

    <div class="ml-pubs__footer">
      <a
        href="https://scholar.google.com/citations?user=jYIZGT0AAAAJ"
        target="_blank"
        rel="noopener noreferrer"
        class="ml-pubs__scholar-link"
      >
        {viewAllLabel[lang]} &rarr;
      </a>
    </div>
  </div>
</section>

<style>
  .ml-pubs {
    background: var(--bg-base, #080B11);
    padding: var(--section-padding, 6rem) 0;
  }

  .ml-pubs__heading {
    font-family: var(--font-display, 'Source Serif 4', serif);
    font-weight: 600;
    font-size: clamp(2rem, 4vw, 3rem);
    color: var(--text-primary, #EAEDF2);
    margin-bottom: 2.5rem;
    letter-spacing: -0.01em;
  }

  /* Year-grouped ledger */
  .ml-pubs__ledger {
    max-width: 960px;
  }

  .ml-pubs__year-group {
    display: grid;
    grid-template-columns: 80px 1fr;
    gap: 2rem;
    margin-bottom: 0;
  }

  .ml-pubs__year-header {
    position: sticky;
    top: 4rem;
    align-self: start;
    padding-top: 1rem;
  }

  .ml-pubs__year {
    font-family: var(--font-display, 'Source Serif 4', serif);
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--accent-warm, #C4956A);
  }

  .ml-pubs__year-entries {
    display: flex;
    flex-direction: column;
  }

  /* Ruled rows */
  .ml-pubs__row {
    border-top: 1px solid rgba(255,255,255,0.06);
    padding: 1rem 0 1rem 0;
    transition: padding-left 0.2s ease, border-left-color 0.2s ease;
    border-left: 3px solid transparent;
  }

  .ml-pubs__year-entries .ml-pubs__row:last-child {
    border-bottom: 1px solid rgba(255,255,255,0.06);
  }

  .ml-pubs__row:hover {
    padding-left: 8px;
    border-left-color: var(--accent-red, #DA291C);
  }

  .ml-pubs__row--first {
    border-left-color: rgba(218,41,28,0.3);
  }

  .ml-pubs__row-content {
    min-width: 0;
  }

  .ml-pubs__title {
    font-family: var(--font-body, 'DM Sans', sans-serif);
    font-weight: 500;
    font-size: 0.9375rem;
    color: var(--text-primary, #EAEDF2);
    line-height: 1.45;
    margin-bottom: 0.25rem;
  }

  .ml-pubs__title-link {
    color: var(--text-primary, #EAEDF2);
    text-decoration: none;
    border-bottom: none;
    transition: color 0.2s ease;
  }

  .ml-pubs__title-link:hover {
    color: var(--accent-warm, #C4956A);
    border-bottom: none;
    transform: none;
  }

  .ml-pubs__title-link:focus-visible {
    outline: 2px solid var(--accent-red, #DA291C);
    outline-offset: 2px;
    border-radius: 2px;
  }

  .ml-pubs__meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .ml-pubs__journal {
    font-family: var(--font-mono, monospace);
    font-size: 0.8125rem;
    color: var(--text-muted, #8B95A3);
    line-height: 1.4;
  }

  .ml-pubs__badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }

  .ml-pubs__first-badge {
    display: inline-block;
    font-family: var(--font-mono, monospace);
    font-size: 0.6875rem;
    font-weight: 500;
    color: var(--accent-red-text, #EF4444);
    background: var(--accent-red-bg, rgba(218, 41, 28, 0.12));
    padding: 0.125rem 0.5rem;
    border-radius: 3px;
  }

  .ml-pubs__quartile-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-family: var(--font-mono, monospace);
    font-size: 0.6875rem;
    font-weight: 600;
    padding: 0.125rem 0.5rem;
    border-radius: 3px;
  }

  .ml-pubs__quartile-badge::before {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .ml-pubs__quartile-badge--q1 { color: #22C55E; background: rgba(34, 197, 94, 0.12); }
  .ml-pubs__quartile-badge--q1::before { background: #22C55E; }
  .ml-pubs__quartile-badge--q2 { color: #3B82F6; background: rgba(59, 130, 246, 0.12); }
  .ml-pubs__quartile-badge--q2::before { background: #3B82F6; }
  .ml-pubs__quartile-badge--q3 { color: #FACC15; background: rgba(250, 204, 21, 0.12); }
  .ml-pubs__quartile-badge--q3::before { background: #FACC15; }

  .ml-pubs__if-badge {
    display: inline-block;
    font-family: var(--font-mono, monospace);
    font-size: 0.6875rem;
    font-weight: 500;
    color: var(--text-muted, #8B95A3);
    background: rgba(255, 255, 255, 0.04);
    padding: 0.125rem 0.5rem;
    border-radius: 3px;
  }

  /* Footer */
  .ml-pubs__footer {
    margin-top: 2.5rem;
  }

  .ml-pubs__scholar-link {
    font-family: var(--font-mono, monospace);
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--accent-warm, #C4956A);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s ease;
    padding: 0.5rem 0;
  }

  .ml-pubs__scholar-link:hover {
    border-bottom-color: var(--accent-warm, #C4956A);
    transform: none;
  }

  .ml-pubs__scholar-link:focus-visible {
    outline: 2px solid var(--accent-red, #DA291C);
    outline-offset: 4px;
    border-radius: 2px;
  }

  @media (max-width: 768px) {
    .ml-pubs {
      padding: 4rem 0;
    }

    .ml-pubs__year-group {
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }

    .ml-pubs__year-header {
      position: static;
      padding-top: 1.5rem;
      padding-bottom: 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .ml-pubs__row {
      padding: 0.875rem 0;
    }
  }
</style>
